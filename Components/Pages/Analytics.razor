@page "/analytics"
@using Mero_Dainiki.Services
@using Mero_Dainiki.Entities
@using Mero_Dainiki.Models
@inject IJournalService JournalService
@inject ITagService TagService

<Mero_Dainiki.Components.Shared.AuthGuard>
<main class="analytics-page">
    <div class="container py-4">
        <!-- Page Header -->
        <div class="analytics-header mb-4 fade-in">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div>
                    <h1 class="display-6 fw-bold mb-2">
                        <i class="bi bi-graph-up me-2 text-primary"></i>Analytics
                    </h1>
                    <p class="text-muted mb-0">Insights about your journaling habits and mood patterns.</p>
                </div>
                <div>
                    <select class="form-select" @bind="SelectedTimeRange" @bind:after="LoadAnalytics">
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="365">This year</option>
                        <option value="0">All time</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Mood distribution & most frequent mood -->
            <div class="col-12 col-lg-6">
                <div class="card shadow-sm border-0 rounded-4 h-100 analytics-card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="bi bi-emoji-smile me-2 text-primary"></i>Mood Distribution
                        </h5>

                        @if (MoodDistribution.Any())
                        {
                            <div class="mb-4">
                                @foreach (var mood in MoodDistribution.OrderByDescending(m => m.Value))
                                {
                                    var percent = TotalEntries > 0 ? (mood.Value * 100) / TotalEntries : 0;
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span>@GetMoodEmoji(mood.Key) @mood.Key</span>
                                        <span class="text-muted">@percent% (@mood.Value entries)</span>
                                    </div>
                                    <div class="progress mb-3" style="height: 10px;">
                                        <div class="progress-bar @GetMoodProgressClass(mood.Key)" style="width: @percent%;"></div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <i class="bi bi-emoji-neutral fs-1 text-muted"></i>
                                <p class="text-muted mt-2">No mood data yet. Start journaling to see your mood patterns!</p>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(MostFrequentMood))
                        {
                            <div class="border rounded-3 p-3 bg-light-subtle">
                                <div class="small text-muted text-uppercase mb-1">Most frequent mood</div>
                                <div class="h5 mb-0">@GetMoodEmoji(MostFrequentMood) @MostFrequentMood</div>
                                <small class="text-muted">Appeared @MoodDistribution.GetValueOrDefault(MostFrequentMood, 0) times in the selected range.</small>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Tag breakdown & most used tags -->
            <div class="col-12 col-lg-6">
                <div class="card shadow-sm border-0 rounded-4 h-100 analytics-card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="bi bi-tags me-2 text-info"></i>Tags Overview
                        </h5>

                        @if (TagUsage.Any())
                        {
                            <div class="mb-3">
                                <div class="small text-muted text-uppercase mb-2">Most used tags</div>
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var tag in TagUsage.OrderByDescending(t => t.Value).Take(5))
                                    {
                                        <span class="badge rounded-pill text-bg-primary">@tag.Key (@tag.Value)</span>
                                    }
                                </div>
                            </div>

                            <div>
                                <div class="small text-muted text-uppercase mb-2">Tag breakdown</div>
                                <table class="table table-sm align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Tag</th>
                                            <th>Entries</th>
                                            <th>Share</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var tag in TagUsage.OrderByDescending(t => t.Value).Take(5))
                                        {
                                            var maxCount = TagUsage.Values.Max();
                                            var percent = maxCount > 0 ? (tag.Value * 100) / maxCount : 0;
                                            <tr>
                                                <td>@tag.Key</td>
                                                <td>@tag.Value</td>
                                                <td>
                                                    <div class="progress" style="height: 6px;">
                                                        <div class="progress-bar bg-primary" style="width: @percent%;"></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <i class="bi bi-tag fs-1 text-muted"></i>
                                <p class="text-muted mt-2">No tags used yet. Add tags to your entries to see usage patterns!</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Streaks & missed days -->
            <div class="col-12 col-lg-4">
                <div class="card shadow-sm border-0 rounded-4 h-100 analytics-card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="bi bi-fire me-2 text-warning"></i>Consistency
                        </h5>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted small text-uppercase">Current streak</span>
                                <span class="fw-semibold">@CurrentStreak days</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted small text-uppercase">Longest streak</span>
                                <span class="fw-semibold">@LongestStreak days</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span class="text-muted small text-uppercase">Total entries</span>
                                <span class="fw-semibold">@TotalEntries entries</span>
                            </div>

                            <div class="border-top pt-3">
                                <small class="text-muted">
                                    @if (CurrentStreak > 0)
                                    {
                                        <text>ðŸ”¥ Great job! You're on a @CurrentStreak-day streak. Keep it going!</text>
                                    }
                                    else
                                    {
                                        <text>Start writing today to begin a new streak!</text>
                                    }
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Journaling activity summary -->
            <div class="col-12 col-lg-8">
                <div class="card shadow-sm border-0 rounded-4 h-100 analytics-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h5 class="card-title mb-1">
                                    <i class="bi bi-activity me-2 text-success"></i>Journaling Activity
                                </h5>
                                <small class="text-muted">Word count and writing patterns</small>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-6 col-md-3">
                                <div class="stat-chip">
                                    <div class="stat-chip-label text-muted text-uppercase small">Total Entries</div>
                                    <div class="stat-chip-value fw-bold">@TotalEntries</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="stat-chip">
                                    <div class="stat-chip-label text-muted text-uppercase small">Avg Words</div>
                                    <div class="stat-chip-value fw-bold">@AverageWordCount.ToString("F0")</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="stat-chip">
                                    <div class="stat-chip-label text-muted text-uppercase small">Total Words</div>
                                    <div class="stat-chip-value fw-bold">@TotalWordCount</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="stat-chip">
                                    <div class="stat-chip-label text-muted text-uppercase small">This Month</div>
                                    <div class="stat-chip-value fw-bold">@EntriesThisMonth</div>
                                </div>
                            </div>
                        </div>

                        <!-- Word count trends visualization -->
                        @if (WordCountTrends.Any())
                        {
                            <div class="bg-light rounded-3 p-3" style="min-height: 160px;">
                                <div class="small text-muted mb-2">Recent entries word count</div>
                                <div class="d-flex align-items-end gap-2" style="height: 110px;">
                                    @foreach (var trend in WordCountTrends.TakeLast(8))
                                    {
                                        var maxWords = WordCountTrends.Max(t => t.WordCount);
                                        var heightPx = maxWords > 0 ? (trend.WordCount * 90) / maxWords + 10 : 10;
                                        <div class="activity-bar" style="height: @(heightPx)px;" title="@trend.Date.ToString("MMM dd"): @trend.WordCount words">
                                            <span class="activity-bar-value">@trend.WordCount</span>
                                        </div>
                                    }
                                </div>
                                <small class="text-muted mt-2">Word counts from your recent entries.</small>
                            </div>
                        }
                        else
                        {
                            <div class="bg-light rounded-3 p-4 text-center">
                                <i class="bi bi-bar-chart fs-1 text-muted"></i>
                                <p class="text-muted mt-2 mb-0">Write more entries to see your word count trends!</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
</Mero_Dainiki.Components.Shared.AuthGuard>

@code {
    private int SelectedTimeRange { get; set; } = 30;
    
    // Analytics data
    private int TotalEntries { get; set; } = 0;
    private int CurrentStreak { get; set; } = 0;
    private int LongestStreak { get; set; } = 0;
    private int EntriesThisMonth { get; set; } = 0;
    private int TotalWordCount { get; set; } = 0;
    private double AverageWordCount { get; set; } = 0;
    private string MostFrequentMood { get; set; } = "";
    
    private Dictionary<string, int> MoodDistribution { get; set; } = new();
    private Dictionary<string, int> TagUsage { get; set; } = new();
    private List<WordCountTrend> WordCountTrends { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadAnalytics();
    }

    private async Task LoadAnalytics()
    {
        try
        {
            // Get analytics from journal service
            var analyticsResult = await JournalService.GetAnalyticsAsync();
            if (analyticsResult.Success && analyticsResult.Data != null)
            {
                var analytics = analyticsResult.Data;
                
                TotalEntries = analytics.TotalEntries;
                CurrentStreak = analytics.CurrentStreak;
                LongestStreak = analytics.LongestStreak;
                AverageWordCount = analytics.AverageWordCount;
                MostFrequentMood = analytics.MostFrequentMood ?? "";
                MoodDistribution = analytics.MoodDistribution ?? new();
                TagUsage = analytics.TagUsage ?? new();
                WordCountTrends = analytics.WordCountTrends ?? new();
            }

            // Get entries for additional calculations
            var entriesResult = await JournalService.GetEntriesAsync(1, 1000);
            if (entriesResult.Success && entriesResult.Data != null)
            {
                var entries = entriesResult.Data;
                
                // Filter by time range if needed
                if (SelectedTimeRange > 0)
                {
                    var cutoffDate = DateTime.Today.AddDays(-SelectedTimeRange);
                    entries = entries.Where(e => e.Date >= cutoffDate).ToList();
                    
                    // Recalculate for filtered entries
                    TotalEntries = entries.Count;
                    
                    MoodDistribution = entries
                        .GroupBy(e => e.PrimaryMood.ToString())
                        .ToDictionary(g => g.Key, g => g.Count());
                    
                    if (MoodDistribution.Any())
                    {
                        MostFrequentMood = MoodDistribution.OrderByDescending(x => x.Value).First().Key;
                    }
                    
                    TagUsage = entries
                        .SelectMany(e => e.Tags)
                        .GroupBy(t => t.Name)
                        .ToDictionary(g => g.Key, g => g.Count());

                    AverageWordCount = entries.Any()
                        ? entries.Average(e => e.Content.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length)
                        : 0;

                    WordCountTrends = entries
                        .OrderBy(e => e.Date)
                        .Select(e => new WordCountTrend
                        {
                            Date = e.Date,
                            WordCount = e.Content.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length
                        })
                        .ToList();
                }

                // Calculate total word count
                TotalWordCount = entries.Sum(e => e.Content.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length);
                
                // Entries this month
                EntriesThisMonth = entries.Count(e => 
                    e.Date.Month == DateTime.Now.Month && 
                    e.Date.Year == DateTime.Now.Year);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading analytics: {ex.Message}");
        }
    }

    private string GetMoodEmoji(string mood) => mood switch
    {
        "VeryHappy" => "ðŸ˜„",
        "Happy" => "ðŸ˜Š",
        "Neutral" => "ðŸ˜",
        "Sad" => "ðŸ˜¢",
        "VerySad" => "ðŸ˜­",
        _ => "ðŸ˜"
    };

    private string GetMoodProgressClass(string mood) => mood switch
    {
        "VeryHappy" or "Happy" => "bg-success",
        "Neutral" => "bg-warning",
        "Sad" or "VerySad" => "bg-danger",
        _ => "bg-secondary"
    };
}
