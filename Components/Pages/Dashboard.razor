@page "/dashboard"
@using Mero_Dainiki.Services
@using Mero_Dainiki.Entities
@inject IJournalService JournalService
@inject ITagService TagService
@inject NavigationManager NavigationManager

<Mero_Dainiki.Components.Shared.AuthGuard>
<main class="dashboard-page">
    <div class="container py-4">
        <!-- Page Header -->
        <div class="dashboard-header mb-4 fade-in">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div>
                    <h1 class="dashboard-title mb-2">Dashboard</h1>
                    <p class="text-muted mb-0">Welcome back! Here's your journaling overview.</p>
                </div>
                <div class="dashboard-date">
                    <i class="bi bi-calendar3 me-2"></i>
                    <span>@DateTime.Now.ToString("MMMM dd, yyyy")</span>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Streak Card with Fire Animation -->
            <div class="col-12 col-lg-4">
                <div class="dashboard-card streak-card h-100">
                    <div class="card-icon-wrapper streak-icon">
                        <i class="bi bi-fire text-warning fs-1"></i>
                    </div>
                    <h5 class="card-title mb-4">
                        <i class="bi bi-lightning-charge-fill me-2 text-warning"></i>Streaks
                    </h5>

                    <div class="streak-stats">
                        <div class="streak-item">
                            <div class="streak-label">Current Streak</div>
                            <div class="streak-value text-primary">
                                <span>@CurrentStreak</span> days
                                @if (CurrentStreak > 0)
                                {
                                    <i class="bi bi-arrow-up-circle-fill text-success ms-2 streak-indicator"></i>
                                }
                            </div>
                        </div>
                        <div class="streak-item">
                            <div class="streak-label">Longest Streak</div>
                            <div class="streak-value">
                                <span>@LongestStreak</span> days
                            </div>
                        </div>
                    </div>

                    <div class="streak-progress-wrapper mt-4">
                        <div class="d-flex justify-content-between mb-2">
                            <small class="text-muted">Progress to beat record</small>
                            <small class="fw-semibold text-primary">@StreakProgressPercent%</small>
                        </div>
                        <div class="progress streak-progress">
                            <div class="progress-bar streak-progress-bar" style="width: @StreakProgressPercent%;"></div>
                        </div>
                        <small class="text-muted mt-2 d-block">
                            @if (CurrentStreak >= LongestStreak && LongestStreak > 0)
                            {
                                <text>ðŸŽ‰ Congratulations! You've matched or beaten your record!</text>
                            }
                            else if (CurrentStreak > 0)
                            {
                                <text>Keep going! You're @(LongestStreak - CurrentStreak) days away from beating your record.</text>
                            }
                            else
                            {
                                <text>Start your streak by writing today's entry!</text>
                            }
                        </small>
                    </div>
                </div>
            </div>

            <!-- Today at a Glance Card -->
            <div class="col-12 col-lg-4">
                <div class="dashboard-card glance-card h-100">
                    <div class="card-icon-wrapper glance-icon">
                        <i class="bi bi-eye text-info fs-1"></i>
                    </div>
                    <h5 class="card-title mb-4">
                        <i class="bi bi-calendar-day me-2 text-info"></i>Today at a Glance
                    </h5>

                    <div class="glance-stats">
                        <div class="glance-item">
                            <div class="glance-icon-wrapper mood-icon">
                                <i class="bi @GetMoodIcon(TodaysMood) @GetMoodColor(TodaysMood) fs-4"></i>
                            </div>
                            <div class="glance-content">
                                <div class="glance-label">Today's Mood</div>
                                <div class="glance-value">
                                    @if (HasTodayEntry)
                                    {
                                        <span class="badge mood-badge @GetMoodBadgeClass(TodaysMood)">@TodaysMood</span>
                                    }
                                    else
                                    {
                                        <span class="badge mood-badge bg-secondary">No entry yet</span>
                                    }
                                </div>
                            </div>
                        </div>
                      
                        <div class="glance-item">
                            <div class="glance-icon-wrapper entries-icon">
                                <i class="bi bi-journal-text text-primary fs-4"></i>
                            </div>
                            <div class="glance-content">
                                <div class="glance-label">Entries this month</div>
                                <div class="glance-value">
                                    <span class="fw-bold text-primary">@EntriesThisMonth</span>
                                    <span class="text-muted"> / @DaysInCurrentMonth days</span>
                                </div>
                            </div>
                        </div>

                        <div class="glance-item">
                            <div class="glance-icon-wrapper tag-icon">
                                <i class="bi bi-hash text-secondary fs-4"></i>
                            </div>
                            <div class="glance-content">
                                <div class="glance-label">Most used tag</div>
                                <div class="glance-value">
                                    @if (!string.IsNullOrEmpty(MostUsedTag))
                                    {
                                        <span class="badge tag-badge bg-secondary">@MostUsedTag</span>
                                    }
                                    else
                                    {
                                        <span class="badge tag-badge bg-secondary">No tags yet</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Card -->
            <div class="col-12 col-lg-4">
                <div class="dashboard-card actions-card h-100">
                    <div class="card-icon-wrapper actions-icon">
                        <i class="bi bi-lightning-charge text-warning fs-1"></i>
                    </div>
                    <h5 class="card-title mb-4">
                        <i class="bi bi-bolt-fill me-2 text-warning"></i>Quick Actions
                    </h5>

                    <div class="quick-actions">
                        <button class="action-btn action-btn-primary w-100 mb-3" @onclick="NavigateToEntry">
                            <i class="bi bi-pencil-square me-2"></i>
                            <span>Write today's entry</span>
                            <i class="bi bi-arrow-right ms-auto"></i>
                        </button>
                        <button class="action-btn action-btn-secondary w-100 mb-3" @onclick="NavigateToCalendar">
                            <i class="bi bi-calendar-week me-2"></i>
                            <span>Open calendar</span>
                            <i class="bi bi-arrow-right ms-auto"></i>
                        </button>
                        <button class="action-btn action-btn-secondary w-100" @onclick="NavigateToAnalytics">
                            <i class="bi bi-bar-chart-line me-2"></i>
                            <span>View analytics</span>
                            <i class="bi bi-arrow-right ms-auto"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent Entries Timeline -->
            <div class="col-12">
                <div class="dashboard-card entries-card">
                    <div class="card-header-custom">
                        <div>
                            <h5 class="card-title mb-1">
                                <i class="bi bi-clock-history me-2 text-primary"></i>Recent Entries
                            </h5>
                            <p class="text-muted small mb-0">Your latest journal entries</p>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" @onclick="NavigateToBrowse">
                            <i class="bi bi-arrow-right me-1"></i>View all
                        </button>
                    </div>

                    @if (RecentEntries.Any())
                    {
                        <div class="entries-list">
                            @foreach (var (item, index) in RecentEntries.Select((item, index) => (item, index)))
                            {
                                <div class="entry-item fade-up" style="animation-delay: @($"{index * 0.1}s")" @onclick="() => ViewEntry(item.Date)">
                                    <div class="entry-timeline">
                                        <div class="timeline-dot"></div>
                                        @if (index < RecentEntries.Count - 1)
                                        {
                                            <div class="timeline-line"></div>
                                        }
                                    </div>
                                    <div class="entry-content">
                                        <div class="entry-header">
                                            <h6 class="entry-title">@item.Title</h6>
                                            <div class="entry-meta">
                                                <span class="entry-date">
                                                    <i class="bi bi-calendar3 me-1"></i>
                                                    @item.Date.ToString("dddd, MMM dd")
                                                </span>
                                                <span class="entry-mood">
                                                    <i class="bi bi-heart-fill me-1"></i>
                                                    @item.PrimaryMood
                                                </span>
                                            </div>
                                        </div>
                                        <div class="entry-tags">
                                            <span class="badge entry-category">@item.Category</span>
                                            @foreach (var tag in item.Tags)
                                            {
                                                <span class="badge entry-tag">@tag</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="bi bi-journal-x fs-1 text-muted mb-3 d-block"></i>
                            <p class="text-muted mb-3">No journal entries yet</p>
                            <button class="btn btn-primary" @onclick="NavigateToEntry">
                                <i class="bi bi-plus-circle me-2"></i>Write your first entry
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</main>
</Mero_Dainiki.Components.Shared.AuthGuard>

@code {
    // Streak data
    private int CurrentStreak { get; set; } = 0;
    private int LongestStreak { get; set; } = 0;
    private int StreakProgressPercent => LongestStreak > 0 ? Math.Min(100, (CurrentStreak * 100) / LongestStreak) : 0;

    // Today's data
    private bool HasTodayEntry { get; set; } = false;
    private string TodaysMood { get; set; } = "";
    private int EntriesThisMonth { get; set; } = 0;
    private int DaysInCurrentMonth => DateTime.DaysInMonth(DateTime.Now.Year, DateTime.Now.Month);
    private string MostUsedTag { get; set; } = "";

    // Recent entries
    private List<RecentEntryVm> RecentEntries { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            // Load streak data
            var streakResult = await JournalService.GetStreakAsync();
            if (streakResult.Success && streakResult.Data != default)
            {
                CurrentStreak = streakResult.Data.current;
                LongestStreak = streakResult.Data.longest;
            }

            // Load all entries for stats
            var entriesResult = await JournalService.GetEntriesAsync(1, 1000);
            if (entriesResult.Success && entriesResult.Data != null)
            {
                var entries = entriesResult.Data;

                // Check for today's entry
                var todayEntry = entries.FirstOrDefault(e => e.Date.Date == DateTime.Today);
                if (todayEntry != null)
                {
                    HasTodayEntry = true;
                    TodaysMood = todayEntry.PrimaryMood.ToString();
                }

                // Count entries this month
                EntriesThisMonth = entries.Count(e => 
                    e.Date.Month == DateTime.Now.Month && 
                    e.Date.Year == DateTime.Now.Year);

                // Find most used tag
                var tagCounts = entries
                    .SelectMany(e => e.Tags)
                    .GroupBy(t => t.Name)
                    .Select(g => new { Name = g.Key, Count = g.Count() })
                    .OrderByDescending(x => x.Count)
                    .FirstOrDefault();

                MostUsedTag = tagCounts?.Name ?? "";

                // Get recent entries
                RecentEntries = entries
                    .OrderByDescending(e => e.Date)
                    .Take(5)
                    .Select(e => new RecentEntryVm
                    {
                        Title = string.IsNullOrEmpty(e.Title) ? "Untitled Entry" : e.Title,
                        Date = e.Date,
                        PrimaryMood = e.PrimaryMood.ToString(),
                        Category = e.Category.ToString(),
                        Tags = e.Tags.Select(t => t.Name).ToArray()
                    })
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard data: {ex.Message}");
        }
    }

    private string GetMoodIcon(string mood) => mood switch
    {
        "VeryHappy" => "bi-emoji-laughing",
        "Happy" => "bi-emoji-smile",
        "Neutral" => "bi-emoji-neutral",
        "Sad" => "bi-emoji-frown",
        "VerySad" => "bi-emoji-tear",
        _ => "bi-emoji-smile"
    };

    private string GetMoodColor(string mood) => mood switch
    {
        "VeryHappy" or "Happy" => "text-success",
        "Neutral" => "text-warning",
        "Sad" or "VerySad" => "text-danger",
        _ => "text-secondary"
    };

    private string GetMoodBadgeClass(string mood) => mood switch
    {
        "VeryHappy" or "Happy" => "bg-success",
        "Neutral" => "bg-warning text-dark",
        "Sad" or "VerySad" => "bg-danger",
        _ => "bg-secondary"
    };

    private void NavigateToEntry()
    {
        NavigationManager?.NavigateTo("/journal");
    }

    private void NavigateToBrowse()
    {
        NavigationManager?.NavigateTo("/browse");
    }

    private void NavigateToCalendar()
    {
        NavigationManager?.NavigateTo("/calendar");
    }

    private void NavigateToAnalytics()
    {
        NavigationManager?.NavigateTo("/analytics");
    }

    private void ViewEntry(DateTime date)
    {
        NavigationManager?.NavigateTo($"/journal/{date:yyyy-MM-dd}");
    }

    private class RecentEntryVm
    {
        public string Title { get; set; } = "";
        public DateTime Date { get; set; }
        public string PrimaryMood { get; set; } = "";
        public string Category { get; set; } = "";
        public string[] Tags { get; set; } = Array.Empty<string>();
    }
}
