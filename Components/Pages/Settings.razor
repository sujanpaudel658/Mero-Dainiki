@page "/settings"
@using Mero_Dainiki.Services

<Mero_Dainiki.Components.Shared.AuthGuard>
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-6 fw-bold">
                <i class="bi bi-gear me-2"></i>Settings
            </h1>
            <p class="text-muted">Customize your app preferences</p>
        </div>
    </div>

    <!-- Settings Message -->
    @if (!string.IsNullOrEmpty(SettingsMessage))
    {
        <div class="alert alert-@(IsSettingsSuccess ? "success" : "danger") alert-dismissible fade show" role="alert">
            <i class="bi bi-@(IsSettingsSuccess ? "check-circle" : "exclamation-circle") me-2"></i>
            @SettingsMessage
            <button type="button" class="btn-close" @onclick="() => SettingsMessage = string.Empty"></button>
        </div>
    }

    <div class="row">
        <div class="col-lg-8">
            <!-- Appearance Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-palette me-2"></i>Appearance</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <label class="form-label d-block mb-2">Theme Mode</label>
                        <div class="btn-group w-100 theme-selector" role="group">
                            <input type="radio" class="btn-check" name="theme-mode" id="theme-light" 
                                   checked="@(ThemeService.CurrentTheme == ThemeMode.Light)" 
                                   @onchange='() => SetTheme(ThemeMode.Light)'>
                            <label class="btn btn-outline-primary" for="theme-light">
                                <i class="bi bi-sun me-2"></i>Light
                            </label>

                            <input type="radio" class="btn-check" name="theme-mode" id="theme-dark" 
                                   checked="@(ThemeService.CurrentTheme == ThemeMode.Dark)" 
                                   @onchange='() => SetTheme(ThemeMode.Dark)'>
                            <label class="btn btn-outline-primary" for="theme-dark">
                                <i class="bi bi-moon-stars me-2"></i>Dark
                            </label>

                            <input type="radio" class="btn-check" name="theme-mode" id="theme-system" 
                                   checked="@(ThemeService.CurrentTheme == ThemeMode.System)" 
                                   @onchange='() => SetTheme(ThemeMode.System)'>
                            <label class="btn btn-outline-primary" for="theme-system">
                                <i class="bi bi-laptop me-2"></i>System
                            </label>
                        </div>
                        <p class="text-muted mt-2 small">Choose your preferred visual style or sync with your device.</p>
                    </div>
                    
                    <hr />
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Font Size</strong>
                            <p class="text-muted mb-0 small">Adjust text size for readability</p>
                        </div>
                        <select class="form-select" style="width: auto;" value="@FontSize" @onchange="ChangeFontSize">
                            <option>Small</option>
                            <option>Medium</option>
                            <option>Large</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Notification Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bell me-2"></i>Notifications</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <strong>Daily Reminder</strong>
                            <p class="text-muted mb-0 small">Get reminded to write your journal</p>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" checked="@DailyReminderEnabled" @onchange="ToggleDailyReminder">
                        </div>
                    </div>
                    <hr />
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Reminder Time</strong>
                            <p class="text-muted mb-0 small">When to send daily reminder</p>
                        </div>
                        <input type="time" class="form-control" value="@ReminderTime" @onchange="ChangeReminderTime" style="width: auto;">
                    </div>
                </div>
            </div>

            <!-- Privacy Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-shield-lock me-2"></i>Security</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <strong>PIN Protection</strong>
                            <p class="text-muted mb-0 small">Protect your journal with a PIN</p>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" checked="@PinEnabled" @onchange="TogglePinProtection">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Management -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-database me-2"></i>Data Management</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <strong>Export Data</strong>
                            <p class="text-muted mb-0 small">Download all your journal entries</p>
                        </div>
                        <button class="btn btn-outline-primary" @onclick="ExportData">
                            <i class="bi bi-download me-1"></i>Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tag Management -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-tags me-2"></i>Tag Management</h5>
                    <button class="btn btn-sm btn-primary" @onclick="ShowCreateTagPrompt">
                        <i class="bi bi-plus-lg me-1"></i>New Tag
                    </button>
                </div>
                <div class="card-body">
                    <div class="tags-container d-flex flex-wrap gap-2">
                        @if (UserTags.Any())
                        {
                            @foreach (var tag in UserTags)
                            {
                                <div class="tag-item badge d-flex align-items-center gap-2 p-2" 
                                     style="background-color: @(tag.Color ?? "#6c757d"); color: white; border: 1px solid rgba(0,0,0,0.1);">
                                    <span>@tag.Name</span>
                                    <button class="btn-close btn-close-white small" 
                                            style="font-size: 0.5rem;"
                                            @onclick="() => DeleteTag(tag.Id)" 
                                            title="Delete tag"></button>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-muted mb-0 small">You haven't created any custom tags yet. Create tags to better organize your journal entries.</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-person-circle display-1 text-primary"></i>
                    </div>
                    <h5>User Profile</h5>
                    <p class="text-muted">@UserEmail</p>
                    <button class="btn btn-outline-primary w-100 mb-2">Edit Profile</button>
                    <button class="btn btn-outline-danger w-100" @onclick="SignOut">Sign Out</button>
                </div>
            </div>
        </div>
    </div>
</div>
</Mero_Dainiki.Components.Shared.AuthGuard>

@code {
    [Inject]
    private IThemeService ThemeService { get; set; } = default!;
    
    [Inject]
    private ISecurityService SecurityService { get; set; } = default!;
    
    [Inject]
    private IUserService UserService { get; set; } = default!;
    
    [Inject]
    private IJSRuntime JS { get; set; } = default!;
    
    [Inject]
    private NavigationManager Navigation { get; set; } = default!;

    [Inject]
    private ITagService TagService { get; set; } = default!;


    private string FontSize { get; set; } = "Medium";
    private bool DailyReminderEnabled { get; set; } = true;
    private string ReminderTime { get; set; } = "20:00";
    private bool PinEnabled { get; set; } = false;
    private string SettingsMessage { get; set; } = string.Empty;
    private bool IsSettingsSuccess { get; set; } = false;
    private string UserEmail { get; set; } = string.Empty;
    private string Username { get; set; } = string.Empty;
    private List<Tag> UserTags { get; set; } = new();

@using Mero_Dainiki.Entities

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ThemeService.InitializeThemeAsync();

            
            // Load user info from database (rest of the code unchanged)
            var user = await UserService.GetCurrentUserAsync();
            if (user != null)
            {
                UserEmail = user.Email;
                Username = user.Username;
            }
            
            // Load other settings from localStorage
            FontSize = await JS.InvokeAsync<string>("localStorage.getItem", "fontSize") ?? "Medium";
            DailyReminderEnabled = await JS.InvokeAsync<bool>("eval", "JSON.parse(localStorage.getItem('dailyReminder') ?? 'true')");
            ReminderTime = await JS.InvokeAsync<string>("localStorage.getItem", "reminderTime") ?? "20:00";
            PinEnabled = await JS.InvokeAsync<bool>("eval", "JSON.parse(localStorage.getItem('pinEnabled') ?? 'false')");
            
            await LoadTags();
            StateHasChanged();
        }
    }

    private async Task LoadTags()
    {
        var result = await TagService.GetAllTagsAsync();
        if (result.Success && result.Data != null)
        {
            UserTags = result.Data;
        }
    }
    
    private void SignOut()
    {
        // Clear MAUI Preferences (this is where auth data is stored)
        Preferences.Default.Remove("current_user_id");
        
        // Reset security service unlock state
        SecurityService.ResetUnlockState();
        
        Navigation.NavigateTo("/login", true);
    }

    private async Task SetTheme(ThemeMode theme)
    {
        await ThemeService.SetThemeAsync(theme);
        ShowSettingsMessage("Theme updated successfully", true);
    }

    private async Task ChangeFontSize(ChangeEventArgs e)
    {
        FontSize = e.Value?.ToString() ?? "Medium";
        await JS.InvokeVoidAsync("localStorage.setItem", "fontSize", FontSize);
        
        // Apply font size using the applyFontSize function
        await JS.InvokeVoidAsync("applyFontSize", FontSize);
        ShowSettingsMessage($"Font size changed to {FontSize}", true);
    }

    private async Task ToggleDailyReminder(ChangeEventArgs e)
    {
        DailyReminderEnabled = (bool)(e.Value ?? false);
        await JS.InvokeVoidAsync("localStorage.setItem", "dailyReminder", DailyReminderEnabled.ToString().ToLower());
        ShowSettingsMessage(DailyReminderEnabled ? "Daily reminder enabled" : "Daily reminder disabled", true);
    }

    private async Task ChangeReminderTime(ChangeEventArgs e)
    {
        ReminderTime = e.Value?.ToString() ?? "20:00";
        await JS.InvokeVoidAsync("localStorage.setItem", "reminderTime", ReminderTime);
        ShowSettingsMessage($"Reminder time set to {ReminderTime}", true);
    }

    private async Task TogglePinProtection(ChangeEventArgs e)
    {
        PinEnabled = (bool)(e.Value ?? false);
        
        if (PinEnabled)
        {
            // Show PIN setup modal
            var pin = await JS.InvokeAsync<string>("prompt", "Enter a 4+ digit PIN:");
            if (!string.IsNullOrEmpty(pin) && pin.Length >= 4)
            {
                var confirmPin = await JS.InvokeAsync<string>("prompt", "Confirm your PIN:");
                if (pin == confirmPin)
                {
                    var result = await SecurityService.SetPinAsync(pin);
                    if (result.Success)
                    {
                        await JS.InvokeVoidAsync("localStorage.setItem", "pinEnabled", "true");
                        await JS.InvokeVoidAsync("localStorage.setItem", "userPin", pin);
                        ShowSettingsMessage("PIN protection enabled successfully", true);
                    }
                    else
                    {
                        ShowSettingsMessage(result.ErrorMessage ?? "Failed to set PIN", false);
                        PinEnabled = false;
                    }
                }
                else
                {
                    ShowSettingsMessage("PINs do not match", false);
                    PinEnabled = false;
                }
            }
            else
            {
                ShowSettingsMessage("PIN must be at least 4 digits", false);
                PinEnabled = false;
            }
        }
        else
        {
            var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to disable PIN protection?");
            if (confirmed)
            {
                var result = await SecurityService.RemovePinAsync("");
                await JS.InvokeVoidAsync("localStorage.setItem", "pinEnabled", "false");
                await JS.InvokeVoidAsync("localStorage.removeItem", "userPin");
                ShowSettingsMessage("PIN protection disabled", true);
            }
            else
            {
                PinEnabled = true;
            }
        }
        
        StateHasChanged();
    }

    private void ShowSettingsMessage(string message, bool success)
    {
        SettingsMessage = message;
        IsSettingsSuccess = success;
        StateHasChanged();
        
        // Auto-hide message after 3 seconds
        Task.Delay(3000).ContinueWith(_ =>
        {
            SettingsMessage = string.Empty;
            StateHasChanged();
        });
    }

    private async Task ExportData()
    {
        await JS.InvokeVoidAsync("alert", "Export functionality coming soon!");
    }

    private async Task DeleteAllData()
    {
        var confirm = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete all data? This cannot be undone.");
        if (confirm)
        {
            // Clear localStorage
            await JS.InvokeVoidAsync("localStorage.clear");
            await JS.InvokeVoidAsync("alert", "All data has been deleted!");
        }
    }

    private async Task ShowCreateTagPrompt()
    {
        var tagName = await JS.InvokeAsync<string>("prompt", "Enter tag name:");
        if (string.IsNullOrWhiteSpace(tagName)) return;

        var tagColor = await JS.InvokeAsync<string>("prompt", "Enter tag color (hex code, e.g., #6366f1) or leave empty for default:", "#6366f1");
        if (string.IsNullOrWhiteSpace(tagColor)) tagColor = "#6366f1";

        var result = await TagService.CreateTagAsync(new Mero_Dainiki.Models.TagViewModel
        {
            Name = tagName,
            Color = tagColor
        });

        if (result.Success)
        {
            await LoadTags();
            ShowSettingsMessage("Tag created successfully", true);
        }
        else
        {
            ShowSettingsMessage(result.ErrorMessage ?? "Failed to create tag", false);
        }
    }

    private async Task DeleteTag(int id)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this tag? It will be removed from all entries.");
        if (confirmed)
        {
            var result = await TagService.DeleteTagAsync(id);
            if (result.Success)
            {
                await LoadTags();
                ShowSettingsMessage("Tag deleted successfully", true);
            }
            else
            {
                ShowSettingsMessage(result.ErrorMessage ?? "Failed to delete tag", false);
            }
        }
    }
}
