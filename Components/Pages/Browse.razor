@page "/browse"
@using Mero_Dainiki.Services
@using Mero_Dainiki.Entities
@inject IJournalService JournalService
@inject ITagService TagService
@inject NavigationManager NavigationManager

<div class="browse-modern-container">
    <div class="browse-header">
        <h1><i class="bi bi-book me-2"></i>Browse Journal</h1>
        <p>Search, filter, and explore your entries</p>
    </div>

    <div class="browse-content">
        <!-- Filters Panel -->
        <div class="filters-panel">
            <h3 class="filters-title"><i class="bi bi-funnel me-2"></i>Filters & Search</h3>

            <!-- Search -->
            <div class="filter-group">
                <label class="filter-label">Search Title or Content</label>
                <input type="text" class="filter-input" placeholder="Type to search..." @bind="SearchText" @bind:event="oninput" />
            </div>

            <!-- Date Range -->
            <div class="filter-group">
                <label class="filter-label">Date Range</label>
                <div class="date-inputs">
                    <input type="date" class="filter-input" @bind="StartDate" />
                    <span class="date-separator">to</span>
                    <input type="date" class="filter-input" @bind="EndDate" />
                </div>
            </div>

            <!-- Mood Filter -->
            <div class="filter-group">
                <label class="filter-label">Filter by Mood</label>
                <div class="mood-filter-grid">
                    @foreach (var mood in System.Enum.GetValues<Mood>())
                    {
                        var isSelected = SelectedMood == mood;
                        <button class="mood-filter-btn @(isSelected ? "selected" : "")" 
                                @onclick="() => ToggleMoodFilter(mood)">
                            @GetMoodEmoji(mood)
                        </button>
                    }
                    <button class="mood-filter-btn @(SelectedMood == null ? "selected" : "")" 
                            @onclick="() => SelectedMood = null">
                        All
                    </button>
                </div>
            </div>

            <!-- Tags Filter -->
            <div class="filter-group">
                <label class="filter-label">Filter by Tags</label>
                <div class="tags-filter-list">
                    @if (AvailableTags.Any())
                    {
                        @foreach (var tag in AvailableTags)
                        {
                            var isSelected = SelectedTags.Contains(tag.Id);
                            <button class="tag-filter-btn @(isSelected ? "selected" : "")" 
                                    @onclick="() => ToggleTagFilter(tag.Id)">
                                @tag.Name
                            </button>
                        }
                    }
                    else
                    {
                        <p class="text-muted">No tags yet</p>
                    }
                </div>
            </div>

            <!-- Apply Filters Button -->
            <button class="btn-apply-filters" @onclick="ApplyFilters">
                Apply Filters
            </button>
            <button class="btn-clear-filters" @onclick="ClearFilters">
                Clear All
            </button>
        </div>

        <!-- Entries List -->
        <div class="entries-panel">
            <div class="entries-header">
                <h3><i class="bi bi-journal-bookmark me-2"></i>Entries (@TotalEntries found)</h3>
                <span class="page-info">Page @CurrentPage of @TotalPages</span>
            </div>

            @if (DisplayedEntries.Any())
            {
                <div class="entries-list">
                    @foreach (var entry in DisplayedEntries)
                    {
                        <div class="entry-card" @onclick="() => ViewEntry(entry.Id)">
                            <div class="entry-header">
                                <div>
                                    <h4>@entry.Title</h4>
                                    <span class="entry-date">@entry.Date.ToString("ddd, MMM dd yyyy")</span>
                                </div>
                                <div class="entry-mood">@GetMoodEmoji(entry.PrimaryMood)</div>
                            </div>

                            <p class="entry-preview">@(entry.Content.Length > 150 ? entry.Content.Substring(0, 150) + "..." : entry.Content)</p>

                            <div class="entry-meta">
                                <span class="category-badge">@entry.Category</span>
                                @if (entry.IsFavorite)
                                {
                                    <span class="favorite-badge">‚≠ê Favorite</span>
                                }
                                @foreach (var tag in entry.Tags.Take(3))
                                {
                                    <span class="tag-badge">@tag.Name</span>
                                }
                                @if (entry.Tags.Count > 3)
                                {
                                    <span class="tag-badge">+@(entry.Tags.Count - 3)</span>
                                }
                            </div>
                        </div>
                    }
                </div>

                <!-- Pagination -->
                <div class="pagination-controls">
                    <button class="btn-page" @onclick="PreviousPage" disabled="@(CurrentPage <= 1)">
                        ‚Üê Previous
                    </button>

                    <div class="page-numbers">
                        @for (int i = 1; i <= TotalPages; i++)
                        {
                            var pageNum = i;
                            <button class="page-number @(CurrentPage == pageNum ? "active" : "")" 
                                    @onclick="() => GoToPage(pageNum)">
                                @pageNum
                            </button>
                        }
                    </div>

                    <button class="btn-page" @onclick="NextPage" disabled="@(CurrentPage >= TotalPages)">
                        Next ‚Üí
                    </button>
                </div>
            }
            else
            {
                <div class="no-entries">
                    <p>No entries found matching your filters.</p>
                </div>
            }
        </div>
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert-error">@ErrorMessage</div>
    }
</div>

@code {
    private string SearchText = "";
    private DateTime StartDate = DateTime.Today.AddMonths(-1);
    private DateTime EndDate = DateTime.Today;
    private Mood? SelectedMood = null;
    private List<int> SelectedTags = new();
    private List<Tag> AvailableTags = new();
    private List<JournalEntry> AllEntries = new();
    private List<JournalEntry> DisplayedEntries = new();
    private int CurrentPage = 1;
    private int PageSize = 10;
    private int TotalEntries = 0;
    private int TotalPages = 0;
    private string ErrorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            var entriesResult = await JournalService.GetEntriesAsync(1, 1000);
            if (entriesResult.Success && entriesResult.Data != null)
            {
                AllEntries = entriesResult.Data.OrderByDescending(e => e.Date).ToList();
            }

            var tagsResult = await TagService.GetAllTagsAsync();
            if (tagsResult.Success && tagsResult.Data != null)
            {
                AvailableTags = tagsResult.Data;
            }

            ApplyFilters();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading data: {ex.Message}";
        }
    }

    private void ApplyFilters()
    {
        var filtered = AllEntries.Where(e =>
        {
            if (!string.IsNullOrWhiteSpace(SearchText))
            {
                var searchLower = SearchText.ToLower();
                if (!e.Title.ToLower().Contains(searchLower) && !e.Content.ToLower().Contains(searchLower))
                    return false;
            }
            if (e.Date.Date < StartDate.Date || e.Date.Date > EndDate.Date)
                return false;
            if (SelectedMood.HasValue && e.PrimaryMood != SelectedMood.Value)
                return false;
            if (SelectedTags.Any() && !e.Tags.Any(t => SelectedTags.Contains(t.Id)))
                return false;
            return true;
        }).ToList();

        TotalEntries = filtered.Count;
        TotalPages = (int)Math.Ceiling((double)TotalEntries / PageSize);
        CurrentPage = 1;
        UpdateDisplayedEntries(filtered);
    }

    private void UpdateDisplayedEntries(List<JournalEntry> entries)
    {
        DisplayedEntries = entries
            .Skip((CurrentPage - 1) * PageSize)
            .Take(PageSize)
            .ToList();
    }

    private void ToggleMoodFilter(Mood mood)
    {
        SelectedMood = SelectedMood == mood ? null : mood;
    }

    private void ToggleTagFilter(int tagId)
    {
        if (SelectedTags.Contains(tagId))
            SelectedTags.Remove(tagId);
        else
            SelectedTags.Add(tagId);
    }

    private void ClearFilters()
    {
        SearchText = "";
        StartDate = DateTime.Today.AddMonths(-1);
        EndDate = DateTime.Today;
        SelectedMood = null;
        SelectedTags.Clear();
        ApplyFilters();
    }

    private void PreviousPage()
    {
        if (CurrentPage > 1)
        {
            CurrentPage--;
            var filtered = GetFilteredEntries();
            UpdateDisplayedEntries(filtered);
        }
    }

    private void NextPage()
    {
        if (CurrentPage < TotalPages)
        {
            CurrentPage++;
            var filtered = GetFilteredEntries();
            UpdateDisplayedEntries(filtered);
        }
    }

    private void GoToPage(int page)
    {
        CurrentPage = page;
        var filtered = GetFilteredEntries();
        UpdateDisplayedEntries(filtered);
    }

    private List<JournalEntry> GetFilteredEntries()
    {
        return AllEntries.Where(e =>
        {
            if (!string.IsNullOrWhiteSpace(SearchText))
            {
                var searchLower = SearchText.ToLower();
                if (!e.Title.ToLower().Contains(searchLower) && !e.Content.ToLower().Contains(searchLower))
                    return false;
            }
            if (e.Date.Date < StartDate.Date || e.Date.Date > EndDate.Date)
                return false;
            if (SelectedMood.HasValue && e.PrimaryMood != SelectedMood.Value)
                return false;
            if (SelectedTags.Any() && !e.Tags.Any(t => SelectedTags.Contains(t.Id)))
                return false;
            return true;
        }).ToList();
    }

    private void ViewEntry(int id)
    {
        var entry = AllEntries.FirstOrDefault(e => e.Id == id);
        if (entry != null)
        {
            NavigationManager.NavigateTo($"/journal/{entry.Date:yyyy-MM-dd}");
        }
    }

    private string GetMoodEmoji(Mood mood) => mood switch
    {
        Mood.Happy => "üòä",
        Mood.Neutral => "üòê",
        Mood.Sad => "üò¢",
        _ => "üòê"
    };
}




