@page "/journal"
@page "/journal/{EntryDateStr}"
@using Mero_Dainiki.Entities
@using Mero_Dainiki.Models
@using Mero_Dainiki.Services
@using Markdig
@implements IAsyncDisposable
@inject IJournalService JournalService
@inject ITagService TagService
@inject ISecurityService SecurityService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JS

@* Check if user is authenticated first *@
@if (!IsAuthenticated)
{
    <Mero_Dainiki.Components.Shared.AuthGuard>
        <p>Loading...</p>
    </Mero_Dainiki.Components.Shared.AuthGuard>
}
else if (PinRequired && !PinVerified)
{
    @* Override layout transitions that break full-screen centered overlays *@
    <style>
        .content { transform: none !important; animation: none !important; }
    </style>
    <div class="pin-verification-modal">
        <div class="pin-verification-dialog">
            <div class="pin-header">
                <h3><i class="bi bi-lock-fill me-2"></i>Journal Protected</h3>
                <p>This journal is protected with a PIN. Please enter your PIN to continue.</p>
            </div>
            <div class="pin-body">
                <input type="password" 
                       class="form-control form-control-lg pin-input" 
                       placeholder="Enter your PIN"
                       @bind="PinInput"
                       @onkeyup="HandlePinKeyPress"
                       maxlength="10" />
                @if (PinError)
                {
                    <div class="alert alert-danger mt-3">Incorrect PIN. Please try again.</div>
                }
            </div>
            <div class="pin-footer">
                <button class="btn btn-primary w-100" @onclick="VerifyPin">Unlock Journal</button>
                <button class="btn btn-outline-secondary w-100 mt-2" @onclick="GoBack">Go Back</button>
            </div>
        </div>
    </div>
}
else
{
<div class="journal-modern-container">
    <!-- Header -->
    <header class="journal-header-modern">
        <div class="header-content">
            <div class="header-left">
                <h1 class="header-title">@(IsEdit ? "Edit Entry" : "New Entry")</h1>
                <div class="header-meta">
                    <span class="meta-date">
                        <i class="bi bi-calendar-event"></i>
                        @DisplayDate
                    </span>
                    <span class="meta-divider"></span>
                    <span class="meta-status @(IsEdit ? "status-draft" : "status-new")">
                        @(IsEdit ? "Draft" : "New")
                    </span>
                </div>
            </div>
            <button class="btn-save-modern" @onclick="SaveEntry" disabled="@IsSaving">
                @if (IsSaving)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                }
                Save
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="journal-main-modern">
        <div class="journal-grid">
            <!-- Left Column: Editor (60%) -->
            <div class="editor-column">
                <!-- Title Input -->
                <div class="input-group-modern">
                    <label class="label-modern">Title</label>
                    <input type="text" 
                           class="input-modern input-title" 
                           placeholder="Entry Title"
                           @bind="EntryModel.Title" />
                </div>

                <!-- Thoughts Section -->
                <div class="input-group-modern flex-1 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="label-modern">Thoughts</label>
                        <span class="word-count">Words: @WordCount</span>
                    </div>

                    <div id="journal-editor">
                        <div class="p-5 text-center text-muted">
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            Loading Editor...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Metadata (40%) -->
            <div class="metadata-column">
                <!-- Mood Selection -->
                <div class="card-modern">
                    <label class="label-modern">Mood</label>
                    <div class="mood-grid">
                        @foreach (var mood in Enum.GetValues<Mood>())
                        {
                            var isSelected = EntryModel.PrimaryMood == mood;
                            <button class="mood-btn @(isSelected ? "selected" : "")"
                                    @onclick="() => EntryModel.PrimaryMood = mood"
                                    title="@mood.ToString()">
                                <span>@GetMoodEmoji(mood)</span>
                            </button>
                        }
                    </div>
                </div>

                <!-- Secondary Moods -->
                <div class="card-modern">
                    <label class="label-modern">Secondary</label>
                    <div class="secondary-moods">
                        @foreach (var mood in Enum.GetValues<Mood>().Take(4))
                        {
                            var isSelected = EntryModel.SecondaryMoods.Contains(mood);
                            <button class="secondary-mood-btn @(isSelected ? "selected" : "")"
                                    @onclick="() => ToggleSecondaryMood(mood)">
                                <span>@GetMoodEmoji(mood)</span>
                                <span class="mood-label">@mood.ToString()</span>
                            </button>
                        }
                    </div>
                </div>

                <!-- Category -->
                <div class="card-modern">
                    <label class="label-modern">Category</label>
                    <select class="select-modern" @bind="EntryModel.Category">
                        @foreach (var category in Enum.GetValues<EntryCategory>())
                        {
                            <option value="@category">@category.ToString()</option>
                        }
                    </select>
                </div>

                <!-- Favorite & Privacy -->
                <div class="card-modern">
                    <button class="toggle-btn-modern" @onclick="() => EntryModel.IsFavorite = !EntryModel.IsFavorite">
                        <i class="bi @(EntryModel.IsFavorite ? "bi-star-fill" : "bi-star")"></i>
                        <span>@(EntryModel.IsFavorite ? "Favorite" : "Mark Favorite")</span>
                    </button>
                </div>

                <!-- Tags Selection -->
                @if (AvailableTags.Any())
                {
                    <div class="card-modern">
                        <label class="label-modern d-block mb-2">Tags</label>
                        <div class="tags-selection">
                            @foreach (var tag in AvailableTags)
                            {
                                var isSelected = EntryModel.TagIds?.Contains(tag.Id) ?? false;
                                <button class="tag-select-btn @(isSelected ? "selected" : "")"
                                        @onclick="() => ToggleTag(tag.Id)">
                                    @tag.Name
                                </button>
                            }
                        </div>
                        <small class="text-muted d-block mt-2">Selected: @(EntryModel.TagIds?.Count ?? 0) tag(s)</small>
                    </div>
                }

                <!-- Delete Button (if editing) -->
                @if (IsEdit)
                {
                    <button class="btn-delete-modern" @onclick="DeleteEntry">
                        <i class="bi bi-trash"></i>
                        Delete Entry
                    </button>
                }

                <!-- Cancel Button -->
                <button class="btn-cancel-modern" @onclick="Cancel">
                    <i class="bi bi-x-lg"></i>
                    Cancel
                </button>

                <!-- Message Display -->
                @if (!string.IsNullOrEmpty(Message))
                {
                    <div class="alert @(IsSuccess ? "alert-success" : "alert-danger") mt-3">
                        @Message
                    </div>
                }
            </div>
        </div>
    </main>
</div>
}

@code {
    [Parameter] public string? EntryDateStr { get; set; }

    private JournalEntryViewModel EntryModel { get; set; } = new();
    private List<Tag> AvailableTags { get; set; } = new();
    private bool IsEdit => EntryModel.Id > 0;
    private bool IsSaving { get; set; } = false;
    private bool ShowPreview { get; set; } = false;
    private string? Message { get; set; }
    private bool IsSuccess { get; set; }
    private bool PinRequired { get; set; } = false;
    private bool PinVerified { get; set; } = false;
    private string PinInput { get; set; } = "";
    private bool PinError { get; set; } = false;
    private bool IsAuthenticated { get; set; } = false;
    private bool IsCheckingAuth { get; set; } = true;
    private bool _editorInitialized = false;
    private DotNetObjectReference<Journal>? _objRef;
    
    private string DisplayDate => EntryModel.Date.ToString("dddd, MMMM dd, yyyy");
    private int WordCount => EntryModel.Content?.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length ?? 0;

    private void ToggleTag(int tagId)
    {
        if (EntryModel.TagIds == null)
            EntryModel.TagIds = new List<int>();

        if (EntryModel.TagIds.Contains(tagId))
            EntryModel.TagIds.Remove(tagId);
        else
            EntryModel.TagIds.Add(tagId);
    }

    // Auth is handled by the OnInitializedAsync at the bottom of the file
    
    private async Task LoadPageData()
    {
        // Check if user has a PIN set and journal is locked
        var hasPinResult = await SecurityService.HasPinAsync();
        var isLockedResult = await SecurityService.IsJournalLockedAsync();
        
        if (hasPinResult.Success && hasPinResult.Data && isLockedResult.Success && isLockedResult.Data)
        {
            PinRequired = true;
            PinVerified = false;
            return; // Don't load data until PIN is verified
        }
        else
        {
            PinRequired = false;
            PinVerified = true;
        }

        var tagsResult = await TagService.GetAllTagsAsync();
        if (tagsResult.Success && tagsResult.Data != null)
        {
            AvailableTags = tagsResult.Data;
        }

        DateTime targetDate = DateTime.Today;
        if (!string.IsNullOrEmpty(EntryDateStr) && DateTime.TryParse(EntryDateStr, out var parsedDate))
        {
            targetDate = parsedDate;
        }

        EntryModel.Date = targetDate;

        var entryResult = await JournalService.GetEntryByDateAsync(targetDate);
        if (entryResult.Success && entryResult.Data != null)
        {
            var entry = entryResult.Data;
            var secondaryMoods = new List<Mood>();
            if (entry.SecondaryMood1.HasValue)
                secondaryMoods.Add(entry.SecondaryMood1.Value);
            if (entry.SecondaryMood2.HasValue)
                secondaryMoods.Add(entry.SecondaryMood2.Value);

            EntryModel = new JournalEntryViewModel
            {
                Id = entry.Id,
                Title = entry.Title,
                Content = entry.Content,
                Date = entry.Date,
                PrimaryMood = entry.PrimaryMood,
                SecondaryMoods = secondaryMoods,
                Category = entry.Category,
                IsFavorite = entry.IsFavorite,
                TagIds = entry.Tags.Select(t => t.Id).ToList()
            };
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var userId = await AuthService.ValidateUserAsync(JS);
        IsAuthenticated = userId > 0;
        IsCheckingAuth = false;

        if (IsAuthenticated) await LoadPageData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsAuthenticated && PinVerified && !_editorInitialized)
        {
            _editorInitialized = true;
            _objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("markdownEditor.init", "journal-editor", EntryModel.Content, _objRef);
        }
    }

    [JSInvokable]
    public void UpdateContentFromJS(string val)
    {
        EntryModel.Content = val;
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        try 
        { 
            _objRef?.Dispose();
            await JS.InvokeVoidAsync("markdownEditor.destroy", "journal-editor"); 
        } catch { }
    }

    private string GetMoodEmoji(Mood mood) => mood switch
    {
        Mood.VeryHappy => "üòÑ",
        Mood.Happy => "üôÇ",
        Mood.Neutral => "üòê",
        Mood.Sad => "üòî",
        Mood.VerySad => "üò¢",
        _ => "üòê"
    };

    private void ToggleSecondaryMood(Mood mood)
    {
        if (EntryModel.SecondaryMoods.Contains(mood)) EntryModel.SecondaryMoods.Remove(mood);
        else if (EntryModel.SecondaryMoods.Count < 2) EntryModel.SecondaryMoods.Add(mood);
    }

    private async Task SaveEntry()
    {
        if (string.IsNullOrWhiteSpace(EntryModel.Content))
        {
            Message = "Please write something in your entry.";
            IsSuccess = false;
            return;
        }

        IsSaving = true;
        try
        {
            var result = IsEdit ? await JournalService.UpdateEntryAsync(EntryModel) : await JournalService.CreateEntryAsync(EntryModel);
            if (result.Success)
            {
                Message = "Saved successfully! Redirecting...";
                IsSuccess = true;
                await Task.Delay(1000);
                Navigation.NavigateTo("/browse");
            }
            else
            {
                Message = result.ErrorMessage;
                IsSuccess = false;
            }
        }
        finally { IsSaving = false; }
    }

    private async Task DeleteEntry()
    {
        if (EntryModel.Id > 0 && await JournalService.DeleteEntryAsync(EntryModel.Id) is { Success: true })
        {
            Navigation.NavigateTo("/browse");
        }
    }

    private async Task VerifyPin()
    {
        if (string.IsNullOrWhiteSpace(PinInput)) { PinError = true; return; }
        
        var result = await SecurityService.UnlockJournalAsync(PinInput);
        if (result.Success)
        {
            PinVerified = true;
            PinRequired = false;
            PinError = false;
            await LoadPageData();
        }
        else PinError = true;
        PinInput = "";
    }

    private async void HandlePinKeyPress(KeyboardEventArgs e) { if (e.Key == "Enter") await VerifyPin(); }
    private void Cancel() => Navigation.NavigateTo("/browse");
    private void GoBack() => Navigation.NavigateTo("/browse");
}

